# âœ… 1ë‹¨ê³„: ë¹Œë“œ ì´ë¯¸ì§€
FROM node:23-alpine AS builder

WORKDIR /app

# ğŸ”‘ ì˜ì¡´ì„± íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬
COPY package.json yarn.lock ./

# âœ… ì˜ì¡´ì„± ì„¤ì¹˜ (ê°œë°œìš© í¬í•¨)
RUN yarn install --network-timeout 600000 --frozen-lockfile

# ğŸ”„ í•„ìš”í•œ íŒŒì¼ë§Œ ë³µì‚¬ (ë¶ˆí•„ìš”í•œ ê²ƒ ì œê±°ë¥¼ ìœ„í•´ .dockerignoreë„ ê¼­ ì„¤ì •)
COPY . .

# âœ… Next.js í”„ë¡œë•ì…˜ ë¹Œë“œ
RUN yarn build


# âœ… 2ë‹¨ê³„: ì‹¤í–‰ ì´ë¯¸ì§€
FROM node:23-alpine AS runner

WORKDIR /app

# ğŸ§Š ì‹œìŠ¤í…œ ë£¨íŠ¸ CA ì¸ì¦ì„œ ì„¤ì¹˜
RUN apk add --no-cache ca-certificates && update-ca-certificates

# ğŸ§¼ ì˜ì¡´ì„± ìµœì†Œí™” (í•„ìˆ˜ ëŸ¬UNTIME only)
COPY package.json yarn.lock ./
RUN yarn install --network-timeout 600000 --frozen-lockfile --production

# âœ… ë¹Œë“œ ì‚°ì¶œë¬¼ë§Œ ë³µì‚¬
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/next.config.mjs ./next.config.mjs

# âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production
EXPOSE 3000

# âœ… ì‹¤í–‰
CMD ["yarn", "start"]
